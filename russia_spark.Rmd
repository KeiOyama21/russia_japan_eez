---
title: "russia_spark"
author: "Kei Oyama"
date: "2024-04-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
#rm(list = ls("all.names" = TRUE))
```

```{r}

#options(repos = c(CRAN = "https://cloud.r-project.org/"))


install.packages("sparklyr")
install.packages("MazamaSpatialUtils")
install.packages("reader")
```

```{r}
library(ggplot2)
library(patchwork)
library(rnaturalearth)
library(MazamaSpatialUtils)
library(sf)
library(sparklyr)
library(arrow)
library(dplyr)
library(stringr)
library(reader)
```


```{r}
conf <- spark_config()
  
#conf$`sparklyr.cores.local` <- 14
  conf$`sparklyr.shell.driver-memory` <- "20G"#自分のパソコン
  conf$spark.memory.fraction <- 0.9

  # Connect to Spark
spark_conn <-spark_connect(master = "local",  config = conf)
```



#もらったparquetを、Gdriveから引っ張ってくる これらはdaily data
```{r}
# 2018:2023年までのdailydataのparquet
dat_area_segs_daily_WE_2018 <- spark_read_parquet( sc = spark_conn, name = "dat_area_segs_daily_WE_2018",
                                    memory = FALSE,  # memory unload  faster to readl for parquest
           
 "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/GFW_data_integration_2/raw/big_area_segs_daily/big_area_segs_daily_WE_2018.parquet")
 
dat_area_segs_daily_WE_2019 <- spark_read_parquet( sc = spark_conn, name = "dat_area_segs_daily_WE_2019",
                                    memory = FALSE,  # memory unload  faster to readl for parquest
           
 "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/GFW_data_integration_2/raw/big_area_segs_daily/big_area_segs_daily_WE_2019.parquet")

dat_area_segs_daily_WE_2020 <- spark_read_parquet( sc = spark_conn, name = "dat_area_segs_daily_WE_2020",
                                    memory = FALSE,  # memory unload  faster to readl for parquest
           
 "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/GFW_data_integration_2/raw/big_area_segs_daily/big_area_segs_daily_WE_2020.parquet")

dat_area_segs_daily_WE_2021 <- spark_read_parquet( sc = spark_conn, name = "dat_area_segs_daily_WE_2021",
                                    memory = FALSE,  # memory unload  faster to readl for parquest
           
 "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/GFW_data_integration_2/raw/big_area_segs_daily/big_area_segs_daily_WE_2021.parquet")

dat_area_segs_daily_WE_2022 <- spark_read_parquet( sc = spark_conn, name = "dat_area_segs_daily_WE_2022",
                                    memory = FALSE,  # memory unload  faster to readl for parquest
           
 "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/GFW_data_integration_2/raw/big_area_segs_daily/big_area_segs_daily_WE_2022.parquet")

dat_area_segs_daily_WE_2023 <- spark_read_parquet( sc = spark_conn, name = "dat_area_segs_daily_WE_2023",
                                    memory = FALSE,  # memory unload  faster to readl for parquest
           
 "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/GFW_data_integration_2/raw/big_area_segs_daily/big_area_segs_daily_WE_2023.parquet")

eez_info_list <- spark_read_parquet( sc = spark_conn, name = "eez_info_list",
                                    memory = FALSE,  # memory unload  faster to readl for parquest
           
 "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Original/gfw/eez_info/eez_info_list.parquet")

dat_area_segs_daily_WE_2018_new <- spark_read_parquet( sc = spark_conn, name = "dat_area_segs_daily_WE_2018_new",
                                    memory = FALSE,  # memory unload  faster to readl for parquest
           
 "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Original/gfw/daily/fixed_upto2023/dat_daily_2017.parquet")


dat_sonota<- spark_read_parquet( sc = spark_conn, name = "dat_sonota",
                                    memory = FALSE,  # memory unload  faster to readl for parquest
           
 "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/GFW_data_integration_2/その他/dat_bq_temp_18_23.parquet")

#country_codeが乗っているリスト
list_country_codes <- spark_read_csv(path = "~/Google Drive/Shared drives/gakuLab_data/Project/gakuLab_vessel_list/list_country/GFWcountry_codes19Aug23_gakulab.csv",
                                     sc = spark_conn,
                                     memory = FALSE,
                                     name = "list_country", delimiter = ",", header = TRUE)

vlist_gfw_2024 <- spark_read_parquet( sc = spark_conn,
                             name = "dat_temp_vlist_gfw_2024",
                             memory = FALSE,
                            "~/Google Drive/Shared drives/gakuLab_data/Project/GFW_data_integration_2/processed/GFW_list/vessel_list_gfw_2024Nov06.parquet")
```


```{r}
#ロシアのsegs_dataに絞ったparquet
segs_russia <- spark_read_parquet( sc = spark_conn,
                             name = "segs_russia",
                             memory = FALSE,
                            "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/data_gfw/Russia_vessel/segs_russia.parquet")



#ロシア船のうち、トロール漁船を見るために使う、vessel_classがあるparquet
segs_russia_vessel_type <- spark_read_parquet( sc = spark_conn,
                             name = "segs_russia_vessel_type",
                             memory = FALSE,
                            "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/data_gfw/Russia_vessel/segs_russia_vessel_type.parquet")



  #"~GoogleDrive/Shared drives/gakuLab_data/Original/gfw/daily/fixed_upto2023/dat_daily_2020.parquet")

#spark_disconnect(sc = spark_conn)
```

```{r}
segs_russia <- segs_russia %>% 
  collect()

segs_russia_vessel_type <- segs_russia_vessel_type %>% 
  mutate(ssvid = as.integer(ssvid)) %>% 
  collect()


```




 #segsデータからロシアをとる、ここをparquetにした
 ```{r}
library(bigrquery)
# プロジェクト名を指定

# プロジェクト名を指定
projectid = "fish-database-275116"
# 引っ張ってくるテーブルを指定 
sql <- "SELECT * FROM `fish-database-275116.GFW_Data.big_area_segs` where ssvid like '273%'"
# クエリの実行および取得データをtibbleとして保存
tb_2 <- bq_project_query(projectid, sql)
# テーブルをダウンロード
segs_korea_russia_japan <- bq_table_download(tb_2)

#parquetとして保存 Gakulabdataのdata_gfwのrussia_vesselの中に格納
write_parquet(segs_korea_russia_japan, "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/data_gfw/Russia_vessel/segs_russia.parquet")


```

 #何の船かがわかる、今回はトロールが見たいため使用　ここをperquetにした
 ```{r}
# プロジェクト名を指定
projectid = "fish-database-275116"
# 引っ張ってくるテーブルを指定
sql_3 <- "SELECT ssvid, year, best_flag, best_vessel_class, best_tonnage_gt FROM `fish-database-275116.GFW_Data.vessel_list_gfw` where ssvid like '273%'"
# クエリの実行および取得データをtibbleとして保存
tb_3 <- bq_project_query(projectid, sql_3)
# テーブルをダウンロード
segs_russia_vessel_type <- bq_table_download(tb_3)

#parquetとして保存 Gakulabdataのdata_gfwのrussia_vesselの中に格納
write_parquet(segs_russia_vessel_type, "/Users/oyamakei/Library/CloudStorage/GoogleDrive-keio@fisheries.agr.iwate-u.ac.jp/Shared drives/gakuLab_data/Project/data_gfw/Russia_vessel/segs_russia_vessel_type.parquet")



```

#daily_dataからrussiaのみを抜き出し、country_codeの追加、緯度経度の追加をする
```{r}
#前準備
#eezにいるかを判断するeez_infoをdailydataに結合したいが、eez_info_listがtimestampを持っていないためdat_sonotaとleft_joinするための操作
dat_sonota <- dat_sonota %>% 
  rename(eez_id = eez_value)

dat_sonota_joined <- dat_sonota %>%
  left_join(eez_info_list, by = "eez_id")

temp_round_0 <- 2  # 小数点第2位
temp_round_1 <- 3  # 小数点第3位
temp_round_2 <- 4  # 小数点第4位

# 2018年
russia_eez_2018 <- dat_area_segs_daily_WE_2018 %>%
  mutate(country_code = as.integer(floor(ssvid / 1000000))) %>%  # ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code")) %>%
  filter(country_code %in% "273") %>%
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>%
  mutate(
    avg_lon = substring_index(avg_lat_lon, " ", 1), # avg_lat_lonをavg_lon, avg_latに分ける
    avg_lat = substring_index(avg_lat_lon, " ", -1),
    seg_id_num = as.numeric(str_sub(seg_id, start = 1L, end = -1L)),
    avg_lon = as.numeric(str_sub(avg_lon, start = 7L, end = -1L)), # str_sub:数値で抽出
    avg_lat = as.numeric(str_sub(avg_lat, start = 1L, end = -2L)),
    year_st = substring_index(first_timestamp, "-", 1),
    month_st = substring_index(substring_index(first_timestamp, "-", 2), "-", -1),
    day_st = str_sub(substring_index(first_timestamp, "-", 3), start = 9, end = 10),
    ave_lon_R = round(avg_lon, temp_round_0),  # 緯度経度 round
    ave_lat_R = round(avg_lat, temp_round_0),
    ave_lon_R_1 = round(avg_lon, temp_round_1),
    ave_lat_R_1 = round(avg_lat, temp_round_1),
    ave_lon_R_2 = round(avg_lon, temp_round_2),
    ave_lat_R_2 = round(avg_lat, temp_round_2)
  ) %>%
  collect()

# 2019年
russia_eez_2019 <- dat_area_segs_daily_WE_2019 %>%
  mutate(country_code = as.integer(floor(ssvid / 1000000))) %>%
  left_join(list_country_codes, by = c("country_code" = "code")) %>%
  filter(country_code %in% "273") %>%
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>%
  mutate(
    avg_lon = substring_index(avg_lat_lon, " ", 1),
    avg_lat = substring_index(avg_lat_lon, " ", -1),
    seg_id_num = as.numeric(str_sub(seg_id, start = 1L, end = -1L)),
    avg_lon = as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),
    avg_lat = as.numeric(str_sub(avg_lat, start = 1L, end = -2L)),
    year_st = substring_index(first_timestamp, "-", 1),
    month_st = substring_index(substring_index(first_timestamp, "-", 2), "-", -1),
    day_st = str_sub(substring_index(first_timestamp, "-", 3), start = 9, end = 10),
    ave_lon_R = round(avg_lon, temp_round_0),
    ave_lat_R = round(avg_lat, temp_round_0),
    ave_lon_R_1 = round(avg_lon, temp_round_1),
    ave_lat_R_1 = round(avg_lat, temp_round_1),
    ave_lon_R_2 = round(avg_lon, temp_round_2),
    ave_lat_R_2 = round(avg_lat, temp_round_2)
  ) %>%
  collect()

# 2020年
russia_eez_2020 <- dat_area_segs_daily_WE_2020 %>%
  mutate(country_code = as.integer(floor(ssvid / 1000000))) %>%
  left_join(list_country_codes, by = c("country_code" = "code")) %>%
  filter(country_code %in% "273") %>%
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>%
  mutate(
    avg_lon = substring_index(avg_lat_lon, " ", 1),
    avg_lat = substring_index(avg_lat_lon, " ", -1),
    seg_id_num = as.numeric(str_sub(seg_id, start = 1L, end = -1L)),
    avg_lon = as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),
    avg_lat = as.numeric(str_sub(avg_lat, start = 1L, end = -2L)),
    year_st = substring_index(first_timestamp, "-", 1),
    month_st = substring_index(substring_index(first_timestamp, "-", 2), "-", -1),
    day_st = str_sub(substring_index(first_timestamp, "-", 3), start = 9, end = 10),
    ave_lon_R = round(avg_lon, temp_round_0),
    ave_lat_R = round(avg_lat, temp_round_0),
    ave_lon_R_1 = round(avg_lon, temp_round_1),
    ave_lat_R_1 = round(avg_lat, temp_round_1),
    ave_lon_R_2 = round(avg_lon, temp_round_2),
    ave_lat_R_2 = round(avg_lat, temp_round_2)
  ) %>%
  collect()

# 2021年
russia_eez_2021 <- dat_area_segs_daily_WE_2021 %>%
  mutate(country_code = as.integer(floor(ssvid / 1000000))) %>%
  left_join(list_country_codes, by = c("country_code" = "code")) %>%
  filter(country_code %in% "273") %>%
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>%
  mutate(
    avg_lon = substring_index(avg_lat_lon, " ", 1),
    avg_lat = substring_index(avg_lat_lon, " ", -1),
    seg_id_num = as.numeric(str_sub(seg_id, start = 1L, end = -1L)),
    avg_lon = as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),
    avg_lat = as.numeric(str_sub(avg_lat, start = 1L, end = -2L)),
    year_st = substring_index(first_timestamp, "-", 1),
    month_st = substring_index(substring_index(first_timestamp, "-", 2), "-", -1),
    day_st = str_sub(substring_index(first_timestamp, "-", 3), start = 9, end = 10),
    ave_lon_R = round(avg_lon, temp_round_0),
    ave_lat_R = round(avg_lat, temp_round_0),
    ave_lon_R_1 = round(avg_lon, temp_round_1),
    ave_lat_R_1 = round(avg_lat, temp_round_1),
    ave_lon_R_2 = round(avg_lon, temp_round_2),
    ave_lat_R_2 = round(avg_lat, temp_round_2)
  ) %>%
  collect()

# 2022年
russia_eez_2022 <- dat_area_segs_daily_WE_2022 %>%
  mutate(country_code = as.integer(floor(ssvid / 1000000))) %>%
  left_join(list_country_codes, by = c("country_code" = "code")) %>%
  filter(country_code %in% "273") %>%
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>%
  mutate(
    avg_lon = substring_index(avg_lat_lon, " ", 1),
    avg_lat = substring_index(avg_lat_lon, " ", -1),
    seg_id_num = as.numeric(str_sub(seg_id, start = 1L, end = -1L)),
    avg_lon = as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),
    avg_lat = as.numeric(str_sub(avg_lat, start = 1L, end = -2L)),
    year_st = substring_index(first_timestamp, "-", 1),
    month_st = substring_index(substring_index(first_timestamp, "-", 2), "-", -1),
    day_st = str_sub(substring_index(first_timestamp, "-", 3), start = 9, end = 10),
    ave_lon_R = round(avg_lon, temp_round_0),
    ave_lat_R = round(avg_lat, temp_round_0),
    ave_lon_R_1 = round(avg_lon, temp_round_1),
    ave_lat_R_1 = round(avg_lat, temp_round_1),
    ave_lon_R_2 = round(avg_lon, temp_round_2),
    ave_lat_R_2 = round(avg_lat, temp_round_2)
  ) %>%
  collect()

# 2023
russia_eez_2023 <- dat_area_segs_daily_WE_2023 %>%
  mutate(country_code = as.integer(floor(ssvid / 1000000))) %>%
  left_join(list_country_codes, by = c("country_code" = "code")) %>%
  filter(country_code %in% "273") %>%
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>%
  mutate(
    avg_lon = substring_index(avg_lat_lon, " ", 1),
    avg_lat = substring_index(avg_lat_lon, " ", -1),
    seg_id_num = as.numeric(str_sub(seg_id, start = 1L, end = -1L)),
    avg_lon = as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),
    avg_lat = as.numeric(str_sub(avg_lat, start = 1L, end = -2L)),
    year_st = substring_index(first_timestamp, "-", 1),
    month_st = substring_index(substring_index(first_timestamp, "-", 2), "-", -1),
    day_st = str_sub(substring_index(first_timestamp, "-", 3), start = 9, end = 10),
    ave_lon_R = round(avg_lon, temp_round_0),
    ave_lat_R = round(avg_lat, temp_round_0),
    ave_lon_R_1 = round(avg_lon, temp_round_1),
    ave_lat_R_1 = round(avg_lat, temp_round_1),
    ave_lon_R_2 = round(avg_lon, temp_round_2),
    ave_lat_R_2 = round(avg_lat, temp_round_2)
  ) %>%
  collect()

```



#日本のeez内で漁獲していたrussia船を示す
```{r}

#日本のeezで漁獲するロシア船のみをフィルタリング
russia_eez_japan_2018 <- dat_area_segs_daily_WE_2018 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  filter(country_code %in% "273") %>% 
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  # territory1 が "Japan" の行のみフィルタ
  filter(eez_id == 8487 & reporting_name == "Japanese Exclusive Economic Zone",fishing_hours > 0 ) %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()
```

```{r}
#韓国のeezで漁獲しているロシア船でフィルタリング
russia_eez_japan_korea_2018 <- dat_area_segs_daily_WE_2018 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  filter(country_code %in% "273") %>% 
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  # territory1 が "Japan" の行のみフィルタ
  filter(eez_id == 8328 , fishing_hours > 0) %>% 
  select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
  collect() 


```
 
```{r}
russia_trawlers <- segs_russia_vessel_type %>%
  filter(best_vessel_class %in% "trawlers", best_flag %in% "RUS") 

russia_trawlers_ssvid <-russia_trawlers$ssvid
```


#2018年に日本のEEZに来たロシア船のうち、トロール船に絞る
```{r}

russia_eez_japan_2018_trwalers <- dat_area_segs_daily_WE_2018 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  filter(country_code %in% "273", ssvid %in% russia_trawlers_ssvid, fishing_hours > 0) %>% 
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  # territory1 が "Japan" の行のみフィルタ
  filter(eez_id == 8487 & reporting_name == "Japanese Exclusive Economic Zone",fishing_hours > 0 ) %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()

#トロール船に絞ったssvidを用いて、韓国のeezで漁獲しているかを見る # 273399580,273425070,273393850,273527500の4隻
russia_eez_japan_korea_2018_trwalers <- dat_area_segs_daily_WE_2018 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  filter(country_code %in% "273", ssvid %in% russia_eez_japan_2018_trwalers$ssvid) %>% 
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  # territory1 が "Japan" の行のみフィルタ
  filter(eez_id == 8328,fishing_hours > 0 ) %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()

```


```{r}
# last_timestampに拘らず、segs_dataで韓国のeez(8328)に行っているものでフィルタリングしてみる
segs_korea_russia_japan_x <- segs_korea_russia_japan %>% 
  filter(fishing_hours > 0, eez_value %in% c("8328","8487"))

ssvid_korea_value <- unique(segs_korea_russia_japan_x$ssvid)

segs_korea_russia_japan_y <- segs_korea_russia_japan %>% 
  filter(fishing_hours > 0 ,ssvid %in% ssvid_korea_value) 
  



```



#spark終了不用意に走らせると面倒
```{r}
spark_disconnect(sc = spark_conn)
```

#日本のeezで漁獲しているロシア船の数を調べる
```{r}
length(unique(russia_eez_japan_2018$ssvid))
length(unique(russia_eez_2023$ssvid))

```

#日本の排他的経済水域の排他的経済水域
```{r}
#

japan_sf <-rnaturalearth::ne_countries(country = c('japan','russia',
                                     'south korea',
                                     'north korea',
                                     'china','taiwan',
                                     'united states of america'),
                         scale="large",
                         returnclass = "sf") %>%　st_transform(crs=4326)
# EEZ
eez_sf <- MazamaSpatialUtils::SimpleCountriesEEZ |>
    st_as_sf() |>
    st_transform(crs = 4326) |>
    filter(countryName == "Japan") 

```


#sf
```{r}


# 日本と近隣国の国境データを取得
japan_sf <- rnaturalearth::ne_countries(country = c('Japan', 'Russia', 'South Korea', 
                                                     'North Korea', 'China', 'Taiwan', 
                                                     'United States of America'),
                                         scale = "large",
                                         returnclass = "sf") %>% 
  st_transform(crs = 4326)

# 日本のEEZデータを取得
eez_sf <- MazamaSpatialUtils::SimpleCountriesEEZ |>
    st_as_sf() |>
    st_transform(crs = 4326) |>
    filter(countryName == "Japan")

# ロシア船のEEZ内での操業データ (russia_eez_japan_2018)をフィルタ
# ここではrussia_eez_japan_2018が、緯度 (avg_lat) と経度 (avg_lon) を持っていると仮定
russia_vessel_sf <- russia_eez_japan_2018 %>%
  filter(!is.na(avg_lon) & !is.na(avg_lat)) %>%
  st_as_sf(coords = c("ave_lon_R_1", "ave_lat_R_2"), crs = 4326)

# プロットの作成
ggplot() +
  # 日本と近隣国の地図を描く
  geom_sf(data = japan_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +  # 日本のEEZを青で描く
  # ロシア船の操業データを緯度経度でプロット
  geom_sf(data = russia_vessel_sf, aes(color = "red"), size = 0.5) +  # ロシア船の位置を赤でプロット
  labs(title = "Russia Vessels Operating in Japan's EEZ") +
  theme_minimal() +
  theme(legend.position = "none")  # 凡例を非表示にする

```
```{r}
russia_vessel_sf <- russia_eez_japan_2018 %>%
  filter(!is.na(avg_lon) & !is.na(avg_lat)) %>%
  st_as_sf(coords = c("avg_lon", "avg_lat"), crs = 4326)

# プロットの作成
ggplot() +
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +  # 日本のEEZを青で描く
  # ロシア船の操業データを緯度経度でプロット
  geom_sf(data = russia_vessel_sf, aes(color = "red"), size = 0.5) +  # ロシア船の位置を赤でプロット
  labs(title = "Russia Vessels Operating in Japan's EEZ") +
  theme_minimal() +
  theme(legend.position = "none") +  # 凡例を非表示にする
  coord_sf(xlim = c(122, 153), ylim = c(24, 45))  # 日本のEEZ範囲に絞る
```


```{r}
# 日本の陸地データを取得
land_sf <- rnaturalearth::ne_countries(country = 'Japan', scale = "large", returnclass = "sf") %>%
  st_transform(crs = 4326)

# ロシア船のEEZ内での操業データ (russia_eez_japan_2018)をフィルタ
# ここではrussia_eez_japan_2018が、緯度 (avg_lat) と経度 (avg_lon) を持っていると仮定
russia_vessel_sf <- russia_eez_japan_2018 %>%
  filter(!is.na(avg_lon) & !is.na(avg_lat)) %>%
  st_as_sf(coords = c("avg_lon", "avg_lat"), crs = 4326)

# プロットの作成
ggplot() +
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +  # 日本のEEZを青で描く
  # 日本の陸地を描く
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +  # 日本の陸地を緑で描く
  # ロシア船の操業データを緯度経度でプロット
  geom_sf(data = russia_vessel_sf, aes(color = "red"), size = 0.5) +  # ロシア船の位置を赤でプロット
  labs(title = "Russia Vessels Operating in Japan's EEZ") +
  theme_minimal() +
  theme(legend.position = "none") +  # 凡例を非表示にする
  coord_sf(xlim = c(120, 160), ylim = c(15, 50))  # 日本のEEZ範囲に絞る
```

```{r}

# アジア全体の陸地データを取得
asia_sf <- rnaturalearth::ne_countries(continent = "Asia", scale = "large", returnclass = "sf") %>%
  st_transform(crs = 4326)

# ロシア船のEEZ内での操業データ (russia_eez_japan_2018)をフィルタ
# ここではrussia_eez_japan_2018が、緯度 (avg_lat) と経度 (avg_lon) を持っていると仮定
russia_vessel_sf <- russia_eez_japan_2018 %>%
  filter(!is.na(avg_lon) & !is.na(avg_lat)) %>%
  st_as_sf(coords = c("avg_lon", "avg_lat"), crs = 4326)

# プロットの作成
ggplot() +
  # アジアの陸地を描く
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +  # アジアの陸地を灰色で描く
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +  # 日本のEEZを青で描く
  # 日本の陸地を描く
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +  # 日本の陸地を緑で描く
  # ロシア船の操業データを緯度経度でプロット
  geom_sf(data = russia_vessel_sf, aes(color = "red"), size = 0.5) +  # ロシア船の位置を赤でプロット
  labs(title = "Russia Vessels Operating in Japan's EEZ") +
  theme_minimal() +
  theme(legend.position = "none") +  # 凡例を非表示にする
  coord_sf(xlim = c(120, 160), ylim = c(20, 50))  # 日本のEEZ範囲に絞る
```



```{r}
# ロシアの陸地データを取得
russia_sf <- rnaturalearth::ne_countries(country = "Russia", scale = "large", returnclass = "sf") %>%
  st_transform(crs = 4326)

# ロシア船のEEZ内での操業データ (russia_eez_japan_2018)をフィルタ
# ここではrussia_eez_japan_2018が、緯度 (avg_lat) と経度 (avg_lon) を持っていると仮定
russia_vessel_sf <- russia_eez_japan_2018 %>%
  filter(!is.na(avg_lon) & !is.na(avg_lat)) %>%
  st_as_sf(coords = c("avg_lon", "avg_lat"), crs = 4326)

# プロットの作成
ggplot() +
  # アジアの陸地を描く
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +  # アジアの陸地を灰色で描く
  # ロシアの陸地を描く
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +  # ロシアの陸地を薄ピンクで描く
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +  # 日本のEEZを青で描く
  # 日本の陸地を描く
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +  # 日本の陸地を緑で描く
  # ロシア船の操業データを緯度経度でプロット
  geom_sf(data = russia_vessel_sf, aes(color = "red"), size = 0.5) +  # ロシア船の位置を赤でプロット
  labs(title = "Russia Vessels Operating in Japan's EEZ") +
  theme_minimal() +
  theme(legend.position = "none") +  # 凡例を非表示にする
  coord_sf(xlim = c(120, 160), ylim = c(20, 50))  # 日本のEEZ範囲に絞る
```

#segsデータの読み込み
```{r}
#russiaのsegsdataカイトさんからcsv形式でもらっていた

russia_eez_seg_csv <- read.csv("/Users/oyamakei/Desktop/russia_japan_eez/big_area_segs_russia.csv")
```

```{r}

length(unique(russia_eez_japan_2018$ssvid))
length(unique(russia_eez_seg_csv$ssvid))


# 共通する値の数を算出
common_ssvid_count <- intersect(russia_eez_japan_2018$ssvid, russia_eez_seg_csv$ssvid) %>%
  length()

# 結果を出力
print(common_ssvid_count)
```



```{r}
russia_eez_segs <- segs_russia %>%
 mutate(
    avg_lat = str_extract(avg_lat_lon, "(?<=POINT\\().*?(?= )") %>% as.numeric(),
    avg_lon = str_extract(avg_lat_lon, "(?<= ).*?(?=\\))") %>% as.numeric()
  )


segs_korea_russia_japan <- segs_korea_russia_japan %>% 
     mutate(
    avg_lat = str_extract(avg_lat_lon, "(?<=POINT\\().*?(?= )") %>% as.numeric(),
    avg_lon = str_extract(avg_lat_lon, "(?<= ).*?(?=\\))") %>% as.numeric()
  )


  
```



```{r}
russia_vessel_sf_segs <- russia_eez_segs %>%
  filter(!is.na(avg_lon) & !is.na(avg_lat)) %>%
  st_as_sf(coords = c("avg_lon", "avg_lat"), crs = 4326)

# プロットの作成
ggplot() +
  # アジアの陸地を描く
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +  # アジアの陸地を灰色で描く
  # ロシアの陸地を描く
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +  # ロシアの陸地を薄ピンクで描く
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +  # 日本のEEZを青で描く
  # 日本の陸地を描く
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +  # 日本の陸地を緑で描く
  # ロシア船の操業データを緯度経度でプロット
  geom_sf(data = russia_vessel_sf, aes(color = "red"), size = 0.5) +  # ロシア船の位置を赤でプロット
  labs(title = "Russia Vessels Operating in Japan's EEZ") +
  theme_minimal() +
  theme(legend.position = "none") +  # 凡例を非表示にする
  coord_sf(xlim = c(120, 160), ylim = c(20, 50))  # 日本のEEZ範囲に絞る
```




#韓国と日本のeez両方で操業しているロシア船の数365隻だった
```{r}
# 共通する ssvid を取得
common_ssvid <- intersect(russia_eez_japan_2018$ssvid, russia_eez_japan_korea_2018$ssvid)

# 共通する ssvid の数を取得
common_count <- length(common_ssvid)

# 結果を出力
print(common_count)
print(common_ssvid)



```


#試しに273390570のsegsでの動向
```{r}
is_present <- russia_eez_segs %>% 
  filter(ssvid == 273390570) %>% 
  nrow() > 0 

print(is_present)
```


```{r}
check_273390570 <-  russia_eez_segs %>% 
  filter(ssvid == 273390570)

check_273390570_sf <- st_as_sf(
  check_273390570,
  coords = c("avg_lat", "avg_lon"),   # 緯度と経度を指定
  crs = 4326                 # 座標系を指定 (例: WGS84)
)

ggplot() +
  # アジアの陸地を描く
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +  # アジアの陸地を灰色で描く
  # ロシアの陸地を描く
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +  # ロシアの陸地を薄ピンクで描く
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +  # 日本のEEZを青で描く
  # 日本の陸地を描く
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +  # 日本の陸地を緑で描く
  # ロシア船の操業データを緯度経度でプロット
  geom_sf(data = check_273390570_sf, aes(color = "red"), size = 0.5) +  # ロシア船の位置を赤でプロット
  labs(title = "check_273390570") +
  theme_minimal() +
  theme(legend.position = "none") +  # 凡例を非表示にする
  coord_sf(xlim = c(120, 160), ylim = c(20, 50))  # 日本のEEZ範囲に絞る

```



#韓国country 440 441
```{r} 
russia_eez_segs_cleaned <- russia_eez_segs %>% 
  unique() %>% 
  filter(ssvid %in% common_ssvid)


# 最後の操業時間が韓国EEZ (8328) で終了したデータをフィルタリング
filtered_data <- segs_korea_russia_japan %>%
  filter(eez_value == 8328, avg_lon >= 33.0 & avg_lon <= 38.0, avg_lat >= 124.5 & avg_lat <= 131.0) %>%  # 韓国EEZ (8328) のデータを抽出
  group_by(ssvid) %>%  # 船ごとにグループ化
  filter(last_timestamp == max(last_timestamp), fishing_hours > 0) %>%  # 最後の操業時間を抽出
  ungroup() # グループ解除x 
  
# 結果確認
head(filtered_data)



filtered_data_sf <- st_as_sf(filtered_data, coords = c("avg_lat", "avg_lon"), crs = 4326)

filtered_data_sf_2 <- st_as_sf(check_ssvid_daily, coords = c("avg_lon", "avg_lat"), crs = 4326)


ggplot() +
  # アジアの陸地を描く
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +  # アジアの陸地を灰色で描く
  # ロシアの陸地を描く
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +  # ロシアの陸地を薄ピンクで描く
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +  # 日本のEEZを青で描く
  # 日本の陸地を描く
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +  # 日本の陸地を緑で描く
  # ロシア船の操業データを緯度経度でプロット
  geom_sf(data = filtered_data_sf, aes(color = "red"), size = 0.5) +  # ロシア船の位置を赤でプロット
  labs(title = "filtered_data_sf") +
  theme_minimal() +
  theme(legend.position = "none") +  # 凡例を非表示にする
  coord_sf(xlim = c(120, 160), ylim = c(20, 50))  # 日本のEEZ範囲に絞る

print(filtered_data$ssvid)

```

```{r}

ggplot() +
  # アジアの陸地を描く
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +  # アジアの陸地を灰色で描く
  # ロシアの陸地を描く
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +  # ロシアの陸地を薄ピンクで描く
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +  # 日本のEEZを青で描く
  # 日本の陸地を描く
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +  # 日本の陸地を緑で描く
  # ロシア船の操業データを緯度経度でプロット
  geom_sf(data = filtered_data_sf_2, aes(color = "red"), size = 0.5) +  # ロシア船の位置を赤でプロット
  labs(title = "filtered_data_sf") +
  theme_minimal() +
  theme(legend.position = "none") +  # 凡例を非表示にする
  coord_sf(xlim = c(120, 160), ylim = c(20, 50))  # 日本のEEZ範囲に絞る
```


```{r}
length(unique(filtered_data$ssvid))
print(unique(filtered_data$ssvid))

korea_last_korea_ssvid <- filtered_data$ssvid
```



##韓国と日本のeez両方で操業しているロシア船の数365隻で,最後に韓国に行ってるのは179
```{r}
# 共通する ssvid を取得
common_ssvid_2 <- intersect(common_ssvid, korea_last_korea_ssvid)

# 共通する ssvid の数を取得
common_count_2 <- length(common_ssvid_2)

# 結果を出力
print(common_count_2)
print(common_ssvid_2)

write.csv(common_ssvid_2, "/Users/oyamakei/Desktop/russia_japan_eez/russia_in_japan.csv")
```

```{r}
check_ssvid_daily <- russia_eez_japan_2018 %>%
  filter(russia_eez_japan_2018$ssvid %in% common_ssvid_2, russia_eez_japan_2018$fishing_hours > 0)


  
  
```

```{r}


russia_eez_japan_2018_ <- st_as_sf(russia_eez_japan_2018_trwalers, coords = c("avg_lat", "avg_lon"), crs = 4326)


ggplot() +
  # アジアの陸地を描く
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +  # アジアの陸地を灰色で描く
  # ロシアの陸地を描く
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +  # ロシアの陸地を薄ピンクで描く
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +  # 日本のEEZを青で描く
  ## 日本の陸地を描く
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +  # 日本の陸地を緑で描く
  # ロシア船の操業データを緯度経度でプロット
  geom_sf(data = filtered_data_sf_2, aes(color = "red"), size = 0.5) +  # ロシア船の位置を赤でプロット
  labs(title = "filtered_data_sf") +
  theme_minimal() +
  theme(legend.position = "none") +  # 凡例を非表示にする
  coord_sf(xlim = c(120, 160), ylim = c(20, 50))  # 日本のEEZ範囲に絞る
```


#sssvid273854000の2018~2023のdaily_dataをみる。(2018はなかったため省略)
```{r}
# 2019
vessel_273854000_2019 <- dat_area_segs_daily_WE_2019 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  #ssvidが273854000で絞る
  filter(ssvid == "273854000") %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()

# 2020
vessel_273854000_2020 <- dat_area_segs_daily_WE_2020 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  #ssvidが273854000で絞る
  filter(ssvid == "273854000") %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()


# 2021
vessel_273854000_2021 <- dat_area_segs_daily_WE_2021 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  #ssvidが273854000で絞る
  filter(ssvid == "273854000") %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()

# 2022
vessel_273854000_2022 <- dat_area_segs_daily_WE_2022 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  #ssvidが273854000で絞る
  filter(ssvid == "273854000") %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()


# 2023
vessel_273854000_2023 <- dat_area_segs_daily_WE_2023 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  #ssvidが273854000で絞る
  filter(ssvid == "273854000") %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()
```

#sssvid273214530の2020~2023のdaily_dataをみる。(GFW上のDates Jan16,2020 ~ Oct 31, 2024)
```{r}

# 2020
vessel_273214530_2020 <- dat_area_segs_daily_WE_2020 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  #ssvidが273854000で絞る
  filter(ssvid == "273214530") %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()


# 2021
vessel_273214530_2021 <- dat_area_segs_daily_WE_2021 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  #ssvidが273854000で絞る
  filter(ssvid == "273214530") %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()

# 2022
vessel_273214530_2022 <- dat_area_segs_daily_WE_2022 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  #ssvidが273854000で絞る
  filter(ssvid == "273214530") %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()


# 2023
vessel_273214530_2023 <- dat_area_segs_daily_WE_2023 %>%
  mutate(country_code = as.integer(floor(ssvid/1000000)))  %>%  　　# ssvidから国コード生成
  left_join(list_country_codes, by = c("country_code" = "code" )) %>%
  # dat_sonota_joined を first_timestamp で結合
  left_join(dat_sonota_joined, by = c("first_timestamp", "seg_id")) %>% 
  #ssvidが273854000で絞る
  filter(ssvid == "273214530") %>% 
  #select(seg_id, ssvid, first_timestamp, eez_id, reporting_name) %>% 
   mutate(avg_lon = substring_index(avg_lat_lon, " ", 1),#avg_lat_lonをavg_lon,avg_latに分ける
          avg_lat = substring_index(avg_lat_lon, " ", -1),
          seg_id_num  = as.numeric(str_sub(seg_id, start = 1L, end = -1L)))%>%
  mutate(avg_lon =as.numeric(str_sub(avg_lon, start = 7L, end = -1L)),#str_sub:数値で指定して抽出
            avg_lat =as.numeric(str_sub(avg_lat, start = 1L, end = -2L)) ) %>%
  mutate (year_st  = substring_index(first_timestamp, "-",1),
            month_st  = substring_index(substring_index(first_timestamp, "-",2), "-", -1),
          day_st =  str_sub(substring_index(first_timestamp, "-",3), start =9, end = 10)) %>%
   mutate(ave_lon_R = round(avg_lon, temp_round_0),　　　# 緯度経度　round
           ave_lat_R = round(avg_lat, temp_round_0),
          ave_lon_R_1 = round(avg_lon, temp_round_1),　　　# 緯度経度　round
           ave_lat_R_1 = round(avg_lat, temp_round_1),
          ave_lon_R_2 = round(avg_lon, temp_round_2),　　　# 緯度経度　round
           ave_lat_R_2 = round(avg_lat, temp_round_2)) %>% 
  collect()
```

```{r}
sf_vessel_273854000_2019 <- st_as_sf(vessel_273854000_2019, coords = c("avg_lon", "avg_lat"), crs = 4326)


# 日時データをRの日時形式に変換
sf_vessel_273854000_2019 <- sf_vessel_273854000_2019 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

# プロット
ggplot() +
  # アジアの陸地を描く
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  # ロシアの陸地を描く
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  # 日本の陸地を描く
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  # ロシア船の操業データを緯度経度でプロット（色を日時データに基づいて変更）
  geom_sf(data = sf_vessel_273854000_2019, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273854000_2019", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")  # 色のグラデーション（古い→新しい）


```
```{r}
# UNIXタイムスタンプをPOSIXct形式に変換
sf_vessel_273854000_2019 <- sf_vessel_273854000_2019 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, origin = "1970-01-01", tz = "UTC"))

# プロット
ggplot() +
  # アジアの陸地を描く
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  # ロシアの陸地を描く
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  # 日本のEEZの地図を描く
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  # 日本の陸地を描く
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  # ロシア船の操業データを緯度経度でプロット（色を日時データに基づいて変更）
  geom_sf(data = sf_vessel_273854000_2019, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273854000_2019", color = "日にち") +  # 凡例タイトルを「日にち」に変更
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")  # 色のグラデーション（古い→新しい）

```
```{r}
# sfオブジェクトに変換
sf_vessel_273854000_2020 <- st_as_sf(vessel_273854000_2020, coords = c("avg_lon", "avg_lat"), crs = 4326)

# 日時データをRの日時形式に変換
sf_vessel_273854000_2020 <- sf_vessel_273854000_2020 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

# プロット
ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273854000_2020, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273854000_2020", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")

```

```{r}
sf_vessel_273854000_2021 <- st_as_sf(vessel_273854000_2021, coords = c("avg_lon", "avg_lat"), crs = 4326)

sf_vessel_273854000_2021 <- sf_vessel_273854000_2021 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273854000_2021, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273854000_2021", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")

```
```{r}
sf_vessel_273854000_2022 <- st_as_sf(vessel_273854000_2022, coords = c("avg_lon", "avg_lat"), crs = 4326)

sf_vessel_273854000_2022 <- sf_vessel_273854000_2022 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273854000_2022, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273854000_2022", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")

```

```{r}
sf_vessel_273854000_2023 <- st_as_sf(vessel_273854000_2023, coords = c("avg_lon", "avg_lat"), crs = 4326)

sf_vessel_273854000_2023 <- sf_vessel_273854000_2023 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273854000_2023, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273854000_2023", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")

```

```{r}
# sfオブジェクトに変換
sf_vessel_273214530_2020 <- st_as_sf(vessel_273214530_2020, coords = c("avg_lon", "avg_lat"), crs = 4326)

# 日時データをRの日時形式に変換
sf_vessel_273214530_2020 <- sf_vessel_273214530_2020 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

# プロット
ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273214530_2020, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273214530_2020", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")

```

```{r}
# sfオブジェクトに変換
sf_vessel_273214530_2021 <- st_as_sf(vessel_273214530_2021, coords = c("avg_lon", "avg_lat"), crs = 4326)

# 日時データをRの日時形式に変換
sf_vessel_273214530_2021 <- sf_vessel_273214530_2021 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

# プロット
ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273214530_2021, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273214530_2021", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")

```

```{r}
# sfオブジェクトに変換
sf_vessel_273214530_2022 <- st_as_sf(vessel_273214530_2022, coords = c("avg_lon", "avg_lat"), crs = 4326)

# 日時データをRの日時形式に変換
sf_vessel_273214530_2022 <- sf_vessel_273214530_2022 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

# プロット
ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273214530_2022, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273214530_2022", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")

```

```{r}
# sfオブジェクトに変換
sf_vessel_273214530_2023 <- st_as_sf(vessel_273214530_2023, coords = c("avg_lon", "avg_lat"), crs = 4326)

# 日時データをRの日時形式に変換
sf_vessel_273214530_2023 <- sf_vessel_273214530_2023 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

# プロット
ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273214530_2023, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273214530_2023", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")

```


```{r}

korean_ports <- data.frame(
  port_name = c("Busan", "Incheon", "Yeosu"),
  latitude = c(35.1796, 37.4563, 34.7609),
  longitude = c(129.0756, 126.7052, 127.6622)
)

# 船の最終位置が韓国の港に近いかを確認（距離計算）
install.packages("geosphere")
library(geosphere)


check_vessel_273854000_2019 <- vessel_273854000_2019 %>%
  rowwise() %>%
  mutate(
    near_korean_port = any(distHaversine(
      c(avg_lon, avg_lat),                    # 船の位置
      korean_ports[, c("avg_lon", "avg_lat")] # 韓国の港の位置
    ) < 5000)                                    # 5km以内
  )

  
  
  
``` 

```{r}
# 重複する行を削除
vessel_273854000_2019_cleaned <- vessel_273854000_2019 %>%
  distinct(first_timestamp, .keep_all = TRUE) %>% 
#first_timestampを日にち順に並べる
   arrange(first_timestamp)
　
vessel_273854000_2020_cleaned <- vessel_273854000_2020 %>%
  distinct(first_timestamp, .keep_all = TRUE) %>% 
  arrange(first_timestamp)

vessel_273854000_2021_cleaned <- vessel_273854000_2021 %>%
  distinct(first_timestamp, .keep_all = TRUE) %>% 
  arrange(first_timestamp)

vessel_273854000_2022_cleaned <- vessel_273854000_2022 %>%
  distinct(first_timestamp, .keep_all = TRUE) %>% 
  arrange(first_timestamp)

vessel_273854000_2023_cleaned <- vessel_273854000_2023 %>%
  distinct(first_timestamp, .keep_all = TRUE) %>% 
  arrange(first_timestamp)

vessel_273214530_2020_cleaned <- vessel_273214530_2020 %>%
  distinct(first_timestamp, .keep_all = TRUE) %>% 
  arrange(first_timestamp)

vessel_273214530_2021_cleaned <- vessel_273214530_2021 %>%
  distinct(first_timestamp, .keep_all = TRUE) %>% 
  arrange(first_timestamp)

vessel_273214530_2022_cleaned <- vessel_273214530_2022 %>%
  distinct(first_timestamp, .keep_all = TRUE) %>% 
  arrange(first_timestamp)

vessel_273214530_2023_cleaned <- vessel_273214530_2023 %>%
  distinct(first_timestamp, .keep_all = TRUE) %>% 
  arrange(first_timestamp)
  

```


#日本の次に韓国に行っている時を抜き出すコード　抜きだせたが、ここから元のデータフレームを見て抜き出した日にち周辺の操業を確認する必要がある。
```{r}
#lagは、nの分だけ指定した列を繰り下げる。lag_01という一個繰下げることで、次の日を表せる 
  
#4/14, 4/17, 5/21, 7/08
addition_next_day_273214530_2020 <- vessel_273214530_2020_cleaned %>% 
  mutate(next_day = lead(reporting_name, n = 1))  %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone" & next_day == "South Korean Exclusive Economic Zone" ) %>% 
  

addition_next_day_273214530_2021 <- vessel_273214530_2021_cleaned %>% 
  mutate(next_day = lead(reporting_name, n = 1)) %>%
  select("reporting_name", "next_day") %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone" & next_day == "South Korean Exclusive Economic Zone" )
  
addition_next_day_273214530_2022 <- vessel_273214530_2022_cleaned %>% 
  mutate(next_day = lead(reporting_name, n = 1)) %>%
  select("reporting_name", "next_day") %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone" & next_day == "South Korean Exclusive Economic Zone" )

addition_next_day_273214530_2023 <- vessel_273214530_2023_cleaned %>% 
  mutate(next_day = lead(reporting_name, n = 1)) %>%
  select("reporting_name", "next_day") %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone" & next_day == "South Korean Exclusive Economic Zone" )

# 273854000
# 10/02
addition_next_day_273854000_2019 <- vessel_273854000_2019_cleaned %>% 
  mutate(next_day = lead(reporting_name, n = 1))  %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone" & next_day == "South Korean Exclusive Economic Zone" ) 
  

addition_next_day_273854000_2020 <- vessel_273854000_2020_cleaned %>% 
  mutate(next_day = lead(reporting_name, n = 1))  %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone" & next_day == "South Korean Exclusive Economic Zone" )  
  

addition_next_day_273854000_2021 <- vessel_273854000_2021_cleaned %>% 
  mutate(next_day = lead(reporting_name, n = 1))  %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone" & next_day == "South Korean Exclusive Economic Zone" )  
  
#10/07
addition_next_day_273854000_2022 <- vessel_273854000_2022_cleaned %>% 
  mutate(next_day = lead(reporting_name, n = 1))  %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone" & next_day == "South Korean Exclusive Economic Zone" ) 
  
addition_next_day_273854000_2023 <- vessel_273854000_2023_cleaned %>% 
  mutate(next_day = lead(reporting_name, n = 1))  %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone" & next_day == "South Korean Exclusive Economic Zone" ) 


```

#vessel_273214530_2020_cleanedの(4/14, 4/17　これは4/10~4/20まで), 5/21, 7/08に韓国からロシアへの移動が見られたため、含まれる月を抜き出してプロットする。sfを使う
```{r}
# sfオブジェクトに変換
sf_vessel_273214530_2020 <- st_as_sf(vessel_273214530_2020_cleaned, coords = c("avg_lon", "avg_lat"), crs = 4326)

# 日時データをRの日時形式に変換
sf_vessel_273214530_2020 <- sf_vessel_273214530_2020 %>%
  mutate(first_timestamp = as.POSIXct(first_timestamp, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

# 4/10 ~ 4/20 
sf_vessel_273214530_2020_0410to0420 <- sf_vessel_273214530_2020 %>%
  filter(
    first_timestamp >= ymd_hms("2020-04-01 00:00:00", tz = "UTC") &
    first_timestamp <= ymd_hms("2020-04-30 23:59:59", tz = "UTC")
  )

# 5/16 ~ 5/26
sf_vessel_273214530_2020_0516to0526 <- sf_vessel_273214530_2020 %>%
  filter(
    first_timestamp >= ymd_hms("2020-05-01 00:00:00", tz = "UTC") &
    first_timestamp <= ymd_hms("2020-05-30 23:59:59", tz = "UTC")
  )

# 7/13 ~ 7/23
sf_vessel_273214530_2020_0713to0723 <- sf_vessel_273214530_2020 %>%
  filter(
    first_timestamp >= ymd_hms("2020-07-01 00:00:00", tz = "UTC") &
    first_timestamp <= ymd_hms("2020-07-30 23:59:59", tz = "UTC")
  )

ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273214530_2020_0410to0420, aes(color = first_timestamp), size = 0.5) +
  labs(title = "273214530 2020年 4月01日〜4月30日", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(120, 160), ylim = c(20, 53)) +
  scale_color_gradient(low = "blue", high = "red")

ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273214530_2020_0516to0526, aes(color = first_timestamp), size = 0.5) +
  labs(title = "273214530 2020年 5月01日〜5月30日", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(120, 160), ylim = c(20, 53)) +
  scale_color_gradient(low = "blue", high = "red")

ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273214530_2020_0713to0723, aes(color = first_timestamp), size = 0.5) +
  labs(title = "273214530 2020年 7月01日〜7月30日", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(120, 160), ylim = c(20, 53)) +
  scale_color_gradient(low = "blue", high = "red")
```


#vessel_273214530_2020_cleanedの(4/14, 4/17　これは4/10~4/20まで), 5/21, 7/08の含まれる月を抜き出してプロットする。sfを使う
```{r}
# sfオブジェクトに変換
sf_vessel_273854000_2019 <- st_as_sf(vessel_273854000_2019_cleaned, coords = c("avg_lon", "avg_lat"), crs = 4326)

# 日時データをRの日時形式に変換
sf_vessel_273214530_2022 <- sf_vessel_273214530_2022 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

# プロット
ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273214530_2022, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273214530_2022", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")

#vessel_273854000_2019_cleanedの10/02の前後５日を抜き出す






# sfオブジェクトに変換
sf_vessel_273214530_2022 <- st_as_sf(vessel_273214530_2022, coords = c("avg_lon", "avg_lat"), crs = 4326)

# 日時データをRの日時形式に変換
sf_vessel_273214530_2022 <- sf_vessel_273214530_2022 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

# プロット
ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273214530_2022, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273214530_2022", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(110, 170), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")






#vessel_273854000_2022_cleanedの10/07日周辺を抜き出す









# sfオブジェクトに変換
sf_vessel_273214530_2022 <- st_as_sf(vessel_273214530_2022, coords = c("avg_lon", "avg_lat"), crs = 4326)

# 日時データをRの日時形式に変換
sf_vessel_273214530_2022 <- sf_vessel_273214530_2022 %>%
  mutate(last_timestamp_x = as.POSIXct(last_timestamp_x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))

# プロット
ggplot() +
  geom_sf(data = asia_sf, fill = 'lightgray', color = 'black') +
  geom_sf(data = russia_sf, fill = 'lightpink', color = 'black') +
  geom_sf(data = eez_sf, fill = 'blue', alpha = 0.3) +
  geom_sf(data = land_sf, fill = 'lightgreen', color = 'black') +
  geom_sf(data = sf_vessel_273214530_2022, aes(color = last_timestamp_x), size = 0.5) +
  labs(title = "sf_vessel_273214530_2022", color = "Date") +
  theme_minimal() +
  coord_sf(xlim = c(120, 160), ylim = c(20, 50)) +
  scale_color_gradient(low = "blue", high = "red")

```




#漁船のssvidを抜き出す ssvid_fishing_gear
```{r}
#タンカーなどを除いた漁船のみ"purse_seines","other_purse_seines","fish_factory","squid_jigger","tuna_purse_seines","trollers","set_gillnets", "pole_and_line", "dredge_fishing","seiners","fishing","trawlers","set_longlines","pots_and_traps",

ssvid_fishing_gear <- segs_russia_vessel_type %>%
  filter(best_vessel_class %in% c("purse_seines","other_purse_seines","fish_factory","squid_jigger","tuna_purse_seines","trollers","set_gillnets", "pole_and_line", "dredge_fishing","seiners","fishing","trawlers","set_longlines","pots_and_traps")) %>% 
  pull(ssvid)
```


#2018 ~ 2023年のdailyデータをロシア船+日本のeezで操業+韓国に行っている+漁船 にフィルタリング
```{r}
# 2018年
cleaned_russia_eez_japan_2018 <- russia_eez_2018 %>%
  filter(
    ssvid %in% (
      intersect(
        ssvid[fishing_hours > 0 & territory1 == "Japan"],
        ssvid[territory1 == "South Korea"])))

catch_fish_cleaned_russia_eez_japan_2018 <- cleaned_russia_eez_japan_2018 %>%
  filter(ssvid %in% ssvid_fishing_gear)

# 2019年
cleaned_russia_eez_japan_2019 <- russia_eez_2019 %>%
  filter(
    ssvid %in% (
      intersect(
        ssvid[fishing_hours > 0 & territory1 == "Japan"],
        ssvid[territory1 == "South Korea"])))

catch_fish_cleaned_russia_eez_japan_2019 <- cleaned_russia_eez_japan_2019 %>%
  filter(ssvid %in% ssvid_fishing_gear)

# 2020年
cleaned_russia_eez_japan_2020 <- russia_eez_2020 %>%
  filter(
    ssvid %in% (
      intersect(
        ssvid[fishing_hours > 0 & territory1 == "Japan"],
        ssvid[territory1 == "South Korea"])))

catch_fish_cleaned_russia_eez_japan_2020 <- cleaned_russia_eez_japan_2020 %>%
  filter(ssvid %in% ssvid_fishing_gear)

# 2021年
cleaned_russia_eez_japan_2021 <- russia_eez_2021 %>%
  filter(
    ssvid %in% (
      intersect(
        ssvid[fishing_hours > 0 & territory1 == "Japan"],
        ssvid[territory1 == "South Korea"])))

catch_fish_cleaned_russia_eez_japan_2021 <- cleaned_russia_eez_japan_2021 %>%
  filter(ssvid %in% ssvid_fishing_gear)

# 2022年
cleaned_russia_eez_japan_2022 <- russia_eez_2022 %>%
  filter(
    ssvid %in% (
      intersect(
        ssvid[fishing_hours > 0 & territory1 == "Japan"],
        ssvid[territory1 == "South Korea"])))

catch_fish_cleaned_russia_eez_japan_2022 <- cleaned_russia_eez_japan_2022 %>%
  filter(ssvid %in% ssvid_fishing_gear)

# 2023年
cleaned_russia_eez_japan_2023 <- russia_eez_2023 %>%
  filter(
    ssvid %in% (
      intersect(
        ssvid[fishing_hours > 0 & territory1 == "Japan"],
        ssvid[territory1 == "South Korea"])))

catch_fish_cleaned_russia_eez_japan_2023 <- cleaned_russia_eez_japan_2023 %>%
  filter(ssvid %in% ssvid_fishing_gear)

  
```

```{r}
gloup_cleaned_russia_ssvid <- cleaned_russia_eez_japan_2023 %>%
  arrange(ssvid)

check_273147000_1 <- dat_area_segs_daily_WE_2023 %>%
  filter(ssvid %in% 273147000) %>% 
  collect()

check_273147000_2 <- russia_eez_2023 %>%
  filter(ssvid %in% 273147000) 
  
check_273000000_1 <- dat_area_segs_daily_WE_2023 %>%
  filter(ssvid %in% 273000000) %>% 
  collect()

check_273000000_2 <- russia_eez_2023 %>%
  filter(ssvid %in% 273000000) 

check_273840810_1 <- fishinggear_cleaned_russia_eez_japan_2023 %>% 
  filter(ssvid %in% 273840810)

check_273840810_2 <- dat_area_segs_daily_WE_2023 %>%
  filter(ssvid %in% 273840810) %>% 
  collect()

print(unique(segs_russia_vessel_type$best_vessel_class))
```

#漁船のみに絞るsvid_fishing_gearの作成
```{r}
#タンカーなどを除いた漁船のみ"purse_seines","other_purse_seines","fish_factory","squid_jigger","tuna_purse_seines","trollers","set_gillnets", "pole_and_line", "dredge_fishing","seiners","fishing","trawlers","set_longlines","pots_and_traps",

ssvid_fishing_gear <- segs_russia_vessel_type %>%
  filter(best_vessel_class %in% c("purse_seines","other_purse_seines","fish_factory","squid_jigger","tuna_purse_seines","trollers","set_gillnets", "pole_and_line", "dredge_fishing","seiners","fishing","trawlers","set_longlines","pots_and_traps")) %>% 
  pull(ssvid)

#fishing_gearのみの船で絞ったdailyデータの船数は171, 2018~2023までのsegs_dataの船数は925 
fishinggear_cleaned_russia_eez_japan_2023 <- cleaned_russia_eez_japan_2023 %>%
  filter(ssvid %in% ssvid_fishing_gear)

length(unique(catch_fish_cleaned_russia_eez_japan_2018$ssvid))  #167
length(unique(catch_fish_cleaned_russia_eez_japan_2019$ssvid))  #188
length(unique(catch_fish_cleaned_russia_eez_japan_2020$ssvid))  #168
length(unique(catch_fish_cleaned_russia_eez_japan_2021$ssvid))  #154
length(unique(catch_fish_cleaned_russia_eez_japan_2022$ssvid))  #175
length(unique(catch_fish_cleaned_russia_eez_japan_2023$ssvid))  #171
length(unique(segs_russia_fishing_vessel$ssvid))  #925


segs_russia_fishing_vessel <- segs_russia %>% 
  filter(ssvid %in% ssvid_fishing_gear) %>% 
  distinct() 


```

#日本のeez内で漁獲する船をフィルタリング, 漁船のみに絞るfishing_gear_ssvidも適用, left_joinで
```{r}
vessel_list <- segs_russia_vessel_type %>% 
  select("ssvid", "best_vessel_class", "best_tonnage_gt") %>% 
  distinct(ssvid, .keep_all = TRUE) %>% #.keep_all = TRUEでssvid以外の列も保持
  mutate(ssvid = as.integer(ssvid))


russia_eez_japan_2018 <- russia_eez_2018 %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone", ssvid %in% ssvid_fishing_gear) %>% 
  left_join(vessel_list %>% select(ssvid, best_vessel_class, best_tonnage_gt), by = "ssvid")

russia_eez_japan_2019<- russia_eez_2019 %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone", ssvid %in% ssvid_fishing_gear) %>% 
  left_join(vessel_list %>% select(ssvid, best_vessel_class, best_tonnage_gt), by = "ssvid")

russia_eez_japan_2020<- russia_eez_2020 %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone", ssvid %in% ssvid_fishing_gear) %>% 
  left_join(vessel_list %>% select(ssvid, best_vessel_class, best_tonnage_gt), by = "ssvid")

russia_eez_japan_2021 <- russia_eez_2021 %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone", ssvid %in% ssvid_fishing_gear) %>% 
  left_join(vessel_list %>% select(ssvid, best_vessel_class, best_tonnage_gt), by = "ssvid")

russia_eez_japan_2022 <- russia_eez_2022 %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone", ssvid %in% ssvid_fishing_gear) %>% 
  left_join(vessel_list %>% select(ssvid, best_vessel_class, best_tonnage_gt), by = "ssvid")

russia_eez_japan_2023 <- russia_eez_2023 %>% 
  filter(reporting_name == "Japanese Exclusive Economic Zone", ssvid %in% ssvid_fishing_gear) %>% 
  left_join(vessel_list %>% select(ssvid, best_vessel_class, best_tonnage_gt), by = "ssvid")

```



#年ごと　ssvidを基準にして、fishing_hourの合計(total_fishing_hour)と、best_vessel_class, best_fishing_hoursをみる
```{r}

# 各年（2018〜2023）について処理を繰り返す
years <- 2018:2023

total_fishing_hours_list <- lapply(years, function(year) {
  russia_eez_japan_year <- get(paste0("russia_eez_japan_", year))  # 年ごとのデータフレームを動的に取得, paste0で空白を消す　
  
  total_fishing_hour <- russia_eez_japan_year %>%
    group_by(ssvid) %>% 
    summarise(
      total_fishing_hours = sum(fishing_hours, na.rm = TRUE),
      best_vessel_class = first(best_vessel_class),  # グループ内の最初の値を取る
      best_tonnage_gt = first(best_tonnage_gt),      # グループ内の最初の値を取る
      .groups = "drop"
    )   
  
  # 結果を名前付きリストとして返す
  assign(paste0("total_fishing_hour_", year), total_fishing_hour, envir = .GlobalEnv)
  
  return(total_fishing_hour)
})

# 必要なデータフレームを結合
combined_total_fishing_hour <- bind_rows(lapply(years, function(year) {
  df <- get(paste0("total_fishing_hour_", year))
  df$year <- year  # 年の列を追加
  return(df)
}))

# 年ごとのfishing_hoursの合計

# 棒グラフを作成
p2 <- ggplot(yearly_fishing_hours, aes(x = factor(year), y = total_fishing_hours)) +
  geom_col(fill = "skyblue", color = "black") +  # 棒の色と枠線
  labs(
    title = "Total Fishing Hours by Year",
    x = "Year",
    y = "Total Fishing Hours"
  ) +
  theme_minimal() +  # シンプルなテーマ
  theme(
    plot.title = element_text(hjust = 0.5, size = 14)  # タイトルを中央揃え
  )

ggsave("fishing_hours_plot.png", plot = p2, width = 8, height = 6, dpi = 300)


```


# 月ごとの fishing_hours の合計を計算
```{r}
# lapplyを使って、各年ごとに処理を繰り返す
monthly_fishing_hour_list <- lapply(years, function(year) {
  # 年ごとのデータフレームを動的に取得
  russia_eez_japan_year <- get(paste0("russia_eez_japan_", year))
  
  # 月ごとの漁獲時間を集計
monthly_fishing_hour <- russia_eez_japan_year %>%
    mutate(month = format(ymd_hms(first_timestamp), "%Y-%m")) %>%  # 日付列を月単位に変換
    group_by(ssvid, month) %>%  # ssvid と月でグループ化
    summarise(
      month_fishing_hour = sum(fishing_hours, na.rm = TRUE),  # 月ごとの合計
      best_vessel_class = first(best_vessel_class),  # グループ内の最初の値を取る
      best_tonnage_gt = first(best_tonnage_gt),
      .groups = "drop"
    ) %>% 
    filter(month_fishing_hour > 0) 
  
  # 結果を名前付きリストとして返す
  assign(paste0("monthly_fishing_hour_", year), monthly_fishing_hour, envir = .GlobalEnv)
  
  return(monthly_fishing_hour)
})
```


```{r}
monthly_fishing_hour_2018to2023 <- rbind(monthly_fishing_hour_2018, monthly_fishing_hour_2019, monthly_fishing_hour_2020, monthly_fishing_hour_2021, monthly_fishing_hour_2022, monthly_fishing_hour_2023)

monthly_total_fishing_hour <- monthly_fishing_hour_2018to2023 %>% 
  group_by(month) %>% 
  summarise(total_fishing_hour = sum(month_fishing_hour, na.rm = TRUE))
```


```{r}
#各年数の棒グラフを作成
# グラフをループで作成して保存
for (year in years) {
  # データフレーム名を動的に作成
  data_name <- paste0("monthly_fishing_hour_", year)
  
  # グラフ作成
  p <- ggplot(get(data_name), aes(x = month, y = month_fishing_hour)) +
    geom_col(fill = "skyblue") +  # 枠線を黒に設定（外側の枠線は残す）
    labs(
      title = paste("Total Fishing Hours by Month-", year),
      x = "Month",
      y = "Total Fishing Hours"
    ) +
    theme_minimal() +  # シンプルなテーマ
    theme(
      plot.title = element_text(hjust = 0.5, size = 14),  # タイトルを中央揃え
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8, color = "black")  # X軸の文字サイズを設定
    )
  
  # ファイル名を作成して保存
  ggsave(paste0("monthly_total_fishing_hour_", year, ".png"), plot = p, width = 8, height = 6, dpi = 300)
}
```



```{r}
# 総年数の月別の棒グラフを作成
p3 <- ggplot(monthly_total_fishing_hour, aes(x = month, y = total_fishing_hour)) +
  geom_col(fill = "skyblue", color = "black") +  # 棒の色と枠線
  labs(
    title = "Total Fishing Hours by Month",
    x = "Month",
    y = "Total Fishing Hours"
  ) +
  theme_minimal() +  # シンプルなテーマ
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),  # タイトルを中央揃え
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8, color = "black")  # X軸の文字サイズを最小値1に設定
  )

ggsave("monthly_total_fishing_hour.png", plot = p3, width = 8, height = 6, dpi = 300)



```




```{r}


# ggplotを使ったグラフ作成
library(ggplot2)

# 色の定義
colors <- c("trawlers" = "blue", 
            "set_longlines" = "green",
            "pots_and_traps" = "orange", 
            "squid_jigger" = "purple",
            "fishing" = "red",
            "other_purse_seines" = "brown",
            "fish_factory" = "pink")



# 2018年から2023年までの各年ごとにグラフを作成して保存
years <- 2018:2023
lapply(years, function(year) {
  # 各年のデータフレームを取得
  df <- get(paste0("total_fishing_hour_", year))
  
  # グラフを作成
  p <- ggplot(df, aes(x = best_vessel_class, y = total_fishing_hours, fill = best_vessel_class)) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = colors) +
    labs(title = paste("Total Fishing Hours by Vessel Class (", year, ")", sep = ""),
         x = "Vessel Class",
         y = "Total Fishing Hours") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  # x軸のラベルを45度傾ける

  # グラフをファイルとして保存
  ggsave(paste0("fishing_hours_", year, ".png"), plot = p, width = 8, height = 6)
})


p1 <- ggplot(total_fishing_hour_2018_2023, aes(x = best_vessel_class, y = total_fishing_hours, fill = best_vessel_class)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = colors) +
  labs(title = "Total Fishing Hours by Vessel Class (2018-2023)",
       x = "Vessel Class",
       y = "Total Fishing Hours") +
  facet_wrap(~ year) +  # 年ごとに分けて表示
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # x軸のラベルを45度傾ける
　
ggsave("Total Fishing Hours by Vessel Class.png", plot = p1, dpi = 1024, width = 8, height = 6)




```


#データ数とユニークssvidの表を作る
```{r}
#日本のeez内で漁獲しているロシア船のunique(ssvid)
l1 <- length(unique(russia_eez_japan_2018$ssvid))
l2 <- length(unique(russia_eez_japan_2019$ssvid))
l3 <- length(unique(russia_eez_japan_2020$ssvid))
l4 <- length(unique(russia_eez_japan_2021$ssvid))
l5 <- length(unique(russia_eez_japan_2022$ssvid))
l6 <- length(unique(russia_eez_japan_2023$ssvid))

#日本のeez内で漁獲しているロシア船のデータ数
n1 <- length(russia_eez_japan_2018$ssvid)
n2 <- length(russia_eez_japan_2019$ssvid)
n3 <- length(russia_eez_japan_2020$ssvid)
n4 <- length(russia_eez_japan_2021$ssvid)
n5 <- length(russia_eez_japan_2022$ssvid)
n6 <- length(russia_eez_japan_2023$ssvid)



unique_ssvids <- c(l1, l2, l3, l4, l5, l6)

# 各年のtotal_fishing_hourのデータ数
total_records <- c(n1, n2, n3, n4, n5, n6)

# 年ごとのデータフレームを作成
fishing_summary <- data.frame(
  Year = c(2018, 2019, 2020, 2021, 2022, 2023),
  Unique_ssvid = unique_ssvids,
  Total_records = total_records
)

# gtテーブルを作成
table <- fishing_summary %>%
  gt() %>%
  tab_header(
    title = "Yearly Fishing Hour Summary",
    subtitle = "Unique SSVIDs and Total Records by Year"
  ) %>%
  cols_label(
    Year = "Year",
    Unique_ssvid = "Unique SSVIDs",
    Total_records = "Total Records"
  )

# テーブルをPNG形式として保存
gtsave(data = table, filename = "fishing_summary.png")


```



















